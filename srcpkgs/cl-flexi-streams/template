# Template file for 'cl-flexi-streams'
pkgname=cl-flexi-streams
version=1.0.19
revision=1
depends="cl-trivial-gray-streams"
checkdepends="sbcl cl-trivial-gray-streams"
short_desc="Flexible bivalent streams for Common Lisp"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="BSD-2-Clause"
homepage="https://github.com/edicl/flexi-streams.git"
distfiles="https://github.com/edicl/flexi-streams/archive/refs/tags/v${version}.tar.gz"
checksum=5e0d4cfa66496ec0ddd501de1d4c19c1d99232ee601d82dce9ef4585f2b47b29

_LIBRARY_DIR=usr/share/common-lisp/source/flexi-streams

do_check() {
	sbcl --non-interactive \
	     --eval '(require "asdf")' \
	     --eval "(push #p\"${wrksrc}/\" asdf:*central-registry*)" \
	     --eval '(asdf:find-system "flexi-streams")' \
	     --eval '(asdf:load-system "flexi-streams-test")' \
	     --eval '(unless (flexi-streams-test:run-all-tests)
	               (uiop:quit 1))'
}

do_install() {
	vmkdir $_LIBRARY_DIR
	vcopy *.lisp $_LIBRARY_DIR
	vcopy flexi-streams.asd $_LIBRARY_DIR
	vdoc docs/index.html
	# NOTE: Manually check license after this before submitting an update!
	sed -n "4,28p" ascii.lisp | cut -c 5- > COPYING
	# Print copyright notice to stdout for visual inspection
	# in the build jobs.
	cat COPYING
	vlicense COPYING
}
