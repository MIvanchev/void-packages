# Template file for 'dosbox-x'
pkgname=dosbox-x
version=2025.02.01
revision=1
build_style=gnu-makefile
build_helper=qemu
hostmakedepends="pkg-config which autoconf automake nasm"
makedepends="SDL2-devel SDL2_net-devel
 libpcap-devel libslirp-devel fluidsynth-devel libavdevice6
 ffmpeg6-devel freetype-devel libxkbfile-devel libXrandr-devel"
depends="hicolor-icon-theme"
short_desc="Cross-platform DOS emulator based on the DOSBox project"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="GPL-2.0-or-later"
homepage="https://github.com/joncampbell123/dosbox-x"
distfiles="https://github.com/joncampbell123/dosbox-x/archive/refs/tags/dosbox-x-v${version}.tar.gz"
checksum=3a6fdfd659bb05db82bf2d850af806f666562cce9a37609fd33b59f7e4bd8fa4
build_options="debug"
desc_option_debug="Enable debugging mode"

do_build() {
	if [ "$CROSS_BUILD" ]; then
		# Host argument for the main build script
		host="--host=${XBPS_CROSS_TRIPLET}"
		# For the vs/sdlnet/build-dosbox.sh subscript
		export opts=" --host=${XBPS_CROSS_TRIPLET}"
	fi
	if [ "$XBPS_TARGET_LIBC" = musl ]; then
		export CFLAGS="$CFLAGS -DUSE_FILE32API"
	fi
	if [ -z "$build_option_debug" ]; then
		vsed -i build-sdl2 -e 's/--enable-debug//'
	fi

	vsed -i vs/sdlnet/build-dosbox.sh -e 's/^opts=$//'

	# Patch the oddly specific number of build jobs.
	vsed -i build-sdl2 -e 's/-j3/'$makejobs'/g'
	vsed -i vs/sdlnet/build-dosbox.sh -e 's/-j3/'$makejobs'/g'

	./build-sdl2 $host
}
