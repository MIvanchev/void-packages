# Template file for 'cl-fiasco'
pkgname=cl-fiasco
#
# NOTE: fiasco doesn't tag versions so we use the date as a
# version and the last commit for that date UTC.
#
_src_date=20200514
_src_hash=bb47d2fef4eb24cc16badc1c9a73d73c3a7e18f5
#
# The version of value should be dynamically computed but this is rejected by
# the linter so instead we set it manually and later check for equality.
#
version=20200514
revision=1
depends="cl-alexandria cl-trivial-gray-streams"
checkdepends="sbcl ${depends}"
short_desc="Test framework for Common Lisp"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="Public Domain"
homepage="https://github.com/joaotavora/fiasco.git"
distfiles="https://github.com/joaotavora/fiasco/archive/${_src_hash}.tar.gz"
checksum=070879b496f78b1048d4533b05a6e13dc1f6711da55f2f35e5d56e1cec92220c

if [ "$version" != "${_src_date}" ]; then
	echo "Version not equal to ${_src_date}.${_src_hash}, must be " 2>&1
	echo "updated manually." 2>&1
	exit 1
fi

_LIBRARY_DIR=usr/share/common-lisp/source/fiasco

do_check() {
	# Taken out of .travis.yml
	sbcl --non-interactive \
	     --eval '(require "asdf")' \
	     --eval "(push #p\"${wrksrc}/\" asdf:*central-registry*)" \
	     --eval '(asdf:load-system "fiasco")' \
	     --eval '(asdf:load-system "fiasco-self-tests")' \
	     --eval "(unless (fiasco:run-tests
	                       (quote (:fiasco-basic-self-tests
	                               :fiasco-intro-example
	                               :fiasco-suite-tests
	                       )))
	               (uiop:quit 1))"
}

do_install() {
	vmkdir $_LIBRARY_DIR
	vcopy src $_LIBRARY_DIR
	vcopy test $_LIBRARY_DIR
	vcopy fiasco.asd $_LIBRARY_DIR
	vlicense LICENCE
}
