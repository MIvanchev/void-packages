# Template file for 'cl-ppcre'
pkgname=cl-ppcre
version=2.1.1
revision=1
depends="cl-flexi-streams"
checkdepends="sbcl cl-flexi-streams"
short_desc="Common Lisp regular expression library"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="BSD-2-Clause"
homepage="https://edicl.github.io/cl-ppcre/"
distfiles=" https://github.com/edicl/cl-ppcre/archive/refs/tags/v${version}.tar.gz"
checksum="89631179b71648d9e6c565a928f6896a9d5742aa2083b9c1b705fe0b45d85def"

# NOTE:
#
# cl-ppcre-unicode is maintained as a separate package due to a circular
# dependency on cl-unicode.
#

_LIBRARY_DIR=usr/share/common-lisp/source/cl-ppcre

post_extract() {
	rm "${wrksrc}/test/unicodetestdata"
	rm "${wrksrc}/test/unicode-tests.lisp"
}

do_check() {
	sbcl --non-interactive \
	     --eval '(require "asdf")' \
	     --eval "(push #p\"${wrksrc}/\" asdf:*central-registry*)" \
	     --eval '(asdf:find-system "cl-ppcre")' \
	     --eval '(asdf:load-system "cl-ppcre-test")' \
	     --eval "(unless (cl-ppcre-test:run-all-tests)
	               (uiop:quit 1))"
}

do_install() {
	vmkdir $_LIBRARY_DIR
	vcopy test $_LIBRARY_DIR
	vcopy *.lisp $_LIBRARY_DIR
	vcopy cl-ppcre.asd $_LIBRARY_DIR
	vdoc docs/index.html
	# NOTE: Manually check license after this before submitting an update!
	#       Also, the master branch includes a LICENSE file so it'd
	#       probably end up in an upcoming release.
	if [ ! -f LICENSE ]; then
		sed -n "6,30p" api.lisp | cut -c 5- > COPYING
		# Print copyright info to stdout for visual inspection
		# in the build jobs.
		cat COPYING
		vlicense COPYING
	else
		echo -n "This if statement is no longer necessary because " 1>&2
		echo "a LICENSE file is present and can be used." 1>&2
		exit 1
	fi
}
