# Template file for 'cl-iterate'
pkgname=cl-iterate
version=1.5.4
revision=1
makedepends="sbcl texlive texlive-dvi texinfo tar"
short_desc="Jonathan Amsterdam's iterator/gatherer/accumulator facility"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="MIT"
homepage="https://gitlab.common-lisp.net/iterate/iterate"
distfiles="https://gitlab.common-lisp.net/iterate/iterate/-/archive/${version}/iterate-${version}.tar.gz"
checksum=7d59b9f52342ebb952ef55ac31966a6eb4642598505547701969c24cadaee5fc

_LIBRARY_DIR=usr/share/common-lisp/source/iterate

do_build() {
	make -C doc
}

do_check() {
	sbcl --non-interactive \
	     --eval '(require "asdf")' \
	     --eval "(push #p\"${wrksrc}/\" asdf:*central-registry*)" \
	     --eval '(asdf:load-system "iterate/tests")' \
	     --eval "(unless (uiop:symbol-call '#:iterate.test '#:do-iterate-tests) \
		      (uiop:quit 1))"
}

do_install() {
	vmkdir $_LIBRARY_DIR
	vcopy iterate.asd $_LIBRARY_DIR
	vcopy package.lisp $_LIBRARY_DIR
	vcopy iterate.lisp $_LIBRARY_DIR
	vcopy iterate-test.lisp $_LIBRARY_DIR
	# FIXME: iterate.info cannot be built for some reason
	# FIXME: the HTML documentation needs some work
	vdoc doc/manual/iterate.pdf
	# NOTE: Manually check license after this before submitting an update!
	sed -n "5,25p" iterate.lisp | cut -c 4- >> COPYING
	sed -n "3,6p" iterate-test.lisp | cut -c 4- >> COPYING
	sed -n "7,25p" iterate-test.lisp | cut -c 3- >> COPYING
	# Print copyright notice to stdout for visual inspection
	# in the build jobs.
	cat COPYING
	vlicense COPYING
}
