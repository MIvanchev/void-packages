# Template file for 'mindustry'
pkgname=mindustry
version=7.0.b146
revision=1
_build=${version##*.b}
hostmakedepends="openjdk17"
depends="virtual?java-runtime desktop-file-utils hicolor-icon-theme"
short_desc="Automation tower defense RTS"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="GPL-3.0-or-later"
homepage="https://mindustrygame.github.io/"
distfiles="https://github.com/Anuken/Arc/archive/refs/tags/v${_build}.tar.gz>Arc.tar.gz
	https://github.com/Anuken/Mindustry/archive/refs/tags/v${_build}.tar.gz>Mindustry.tar.gz"
checksum="30cc1b00968aaec8dbb76a2dad6439c7d7418970fafe24c350b2be4e68c3e5d6
 aa1684d87d9f3e1d1a2da415b5e055ea6493fe31398748447927bd903019adbd"
skip_extraction="Arc.tar.gz Mindustry.tar.gz"
nocross="Build involves JNI steps which are incompatible with cross builds"
build_wrksrc=Mindustry-${_build}
patch_args="-Np1 --directory=${build_wrksrc}"

# TODO: Make sure this template doesn't download anything. Currently not possible
# because Void's Gradle version is incompatible.

# TODO: Mindustry will not run on JRE<17, but we have no way to check this because
# virtual?java-runtime>=17 doesn't seem to work.

case "$XBPS_TARGET_MACHINE" in
	i686*) broken="Couldn't load shared library 'libarc.so' for target: Linux, 32-bit" ;;
	*-musl) broken="Couldn't load shared library" ;;
esac

# JAVA_HOME needs to be set because otherwise gradle fails to find Java.

export JAVA_HOME=/usr/lib/jvm/openjdk17

post_extract() {
	vsrcextract -C Arc Arc.tar.gz
	vsrcextract -C ${build_wrksrc} Mindustry.tar.gz
}

do_build() {
	./gradlew --no-daemon dist -Pbuildversion="${_build}" desktop:dist server:dist
}

do_install() {
	vmkdir usr/share/mindustry
	vinstall desktop/build/libs/Mindustry.jar 644 usr/share/mindustry
	vbin ${FILESDIR}/mindustry
	vinstall core/assets/icons/icon_64.png 644 usr/share/icons/hicolor/64x64/apps mindustry.png
}

mindustry-server_package() {
	short_desc+=" (server)"
	pkg_install() {
		vmkdir usr/share/mindustry
		vinstall server/build/libs/server-release.jar 644 usr/share/mindustry
		vbin ${FILESDIR}/mindustry-server
	        vinstall core/assets/icons/icon_64.png 644 usr/share/icons/hicolor/64x64/apps mindustry-server.png
	}
}
