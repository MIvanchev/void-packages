# Template file for 'cl-ppcre-unicode'
pkgname=cl-ppcre-unicode
version=2.1.1
revision=1
depends="cl-ppcre cl-unicode"
checkdepends="sbcl cl-ppcre cl-unicode"
short_desc="Common Lisp regular expression library (Unicode property support)"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="BSD-2-Clause"
homepage="https://edicl.github.io/cl-ppcre/"
distfiles=" https://github.com/edicl/cl-ppcre/archive/refs/tags/v${version}.tar.gz"
checksum=89631179b71648d9e6c565a928f6896a9d5742aa2083b9c1b705fe0b45d85def

# NOTE:
#
# This is a separate package from cl-ppcre due to a circular dependency on
# cl-unicode.
#

_LIBRARY_DIR=usr/share/common-lisp/source/cl-ppcre-unicode

do_check() {
	sbcl --non-interactive \
	     --eval '(require "asdf")' \
	     --eval "(push #p\"${wrksrc}/\" asdf:*central-registry*)" \
	     --eval '(asdf:find-system "cl-ppcre")' \
	     --eval '(asdf:load-system "cl-ppcre-test")' \
	     --eval '(asdf:find-system "cl-ppcre-unicode")' \
	     --eval '(asdf:load-system "cl-ppcre-unicode-test")' \
	     --eval "(unless (cl-ppcre-test:run-all-tests :more-tests 'cl-ppcre-test:unicode-test)
	               (uiop:quit 1))"
}

do_install() {
	vmkdir $_LIBRARY_DIR
	vmkdir $_LIBRARY_DIR/test
	vcopy test/unicode-tests.lisp $_LIBRARY_DIR/test
	vcopy test/unicodetestdata $_LIBRARY_DIR/test
	vcopy cl-ppcre-unicode $_LIBRARY_DIR
	vcopy cl-ppcre-unicode.asd $_LIBRARY_DIR
	vdoc docs/index.html
	# NOTE: Manually check license after this before submitting an update!
	#       Also, the master branch includes a LICENSE file so it'd
	#       probably end up in an upcoming release.
	if [ ! -f LICENSE ]; then
		sed -n "6,30p" api.lisp | cut -c 5- > COPYING
		# Print copyright info to stdout for visual inspection
		# in the build jobs.
		cat COPYING
		vlicense COPYING
	else
		echo -n "This if statement is no longer necessary because " 1>&2
		echo "a LICENSE file is present and can be used." 1>&2
		exit 1
	fi
}
