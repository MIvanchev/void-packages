# Template file for 'cl-trivial-gray-streams'
pkgname=cl-trivial-gray-streams
#
# NOTE: trivial-gray-streams doesn't tag versions so we use the date as a
# version and the last commit for that date UTC.
#
# According to this discsion:
#
# https://github.com/trivial-gray-streams/trivial-gray-streams/issues/15
#
# every push to master is a release.
#
_src_date=20240217
_src_hash=a7ead683666849762ea657dac9137d693c5a4929
version=20240217
revision=1
checkdepends="sbcl"
short_desc="Portability library for CL gray streams"
maintainer="Mihail Ivanchev <contact@ivanchev.net>"
license="MIT"
homepage="https://github.com/trivial-gray-streams/trivial-gray-streams.git"
distfiles="https://github.com/trivial-gray-streams/trivial-gray-streams/archive/${_src_hash}.tar.gz"
checksum=0b3734561620a27f42e7960312282d732ff6313278db18aa376450a15a8ce8e6

if [ "$version" != "${_src_date}" ]; then
	echo "Version not equal to ${_src_date}, must be " 2>&1
	echo "updated manually." 2>&1
	exit 1
fi

_LIBRARY_DIR=usr/share/common-lisp/source/trivial-gray-streams

do_check() {
	# According to the author, the failure in stream-advance-to-column
	# currently happens across all LISP implementations and is expected.
	# See: https://github.com/trivial-gray-streams/trivial-gray-streams/issues/16
	sbcl --non-interactive \
	     --eval '(require "asdf")' \
	     --eval "(push #p\"${wrksrc}/\" asdf:*central-registry*)" \
	     --eval '(asdf:load-system "trivial-gray-streams-test")' \
	     --eval '(in-package :trivial-gray-streams-test)' \
	     --eval '(when (not (equal (list "stream-advance-to-column")
	                               (failed-test-names (run-tests))))
	               (uiop:quit 1))'
}

do_install() {
	vmkdir $_LIBRARY_DIR
	vcopy *.lisp $_LIBRARY_DIR
	vcopy trivial-gray-streams.asd $_LIBRARY_DIR
	vlicense COPYING
}
